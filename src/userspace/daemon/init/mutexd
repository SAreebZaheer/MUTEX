#!/bin/bash
#
# mutexd - MUTEX daemon init script
#
# chkconfig: 2345 90 10
# description: MUTEX kernel-level proxy daemon

### BEGIN INIT INFO
# Provides:          mutexd
# Required-Start:    $network $local_fs
# Required-Stop:     $network $local_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: MUTEX proxy daemon
# Description:       Kernel-level proxy service for MUTEX
### END INIT INFO

NAME=mutexd
DAEMON=/usr/local/bin/$NAME
PIDFILE=/var/run/$NAME.pid
CONF=/etc/mutex/mutex.conf

# Source function library (if available)
if [ -f /etc/init.d/functions ]; then
    . /etc/init.d/functions
fi

# Check if daemon exists
test -x $DAEMON || exit 5

case "$1" in
    start)
        echo -n "Starting $NAME: "
        if [ -f $PIDFILE ]; then
            PID=$(cat $PIDFILE)
            if kill -0 $PID 2>/dev/null; then
                echo "already running (PID $PID)"
                exit 0
            fi
        fi

        $DAEMON -c $CONF
        RETVAL=$?

        if [ $RETVAL -eq 0 ]; then
            echo "OK"
        else
            echo "FAILED"
        fi
        ;;

    stop)
        echo -n "Stopping $NAME: "
        if [ ! -f $PIDFILE ]; then
            echo "not running"
            exit 0
        fi

        PID=$(cat $PIDFILE)
        kill -TERM $PID 2>/dev/null
        RETVAL=$?

        # Wait for process to stop
        for i in {1..10}; do
            if ! kill -0 $PID 2>/dev/null; then
                rm -f $PIDFILE
                echo "OK"
                exit 0
            fi
            sleep 1
        done

        # Force kill if still running
        kill -KILL $PID 2>/dev/null
        rm -f $PIDFILE
        echo "OK (forced)"
        ;;

    restart)
        $0 stop
        sleep 2
        $0 start
        ;;

    reload)
        echo -n "Reloading $NAME configuration: "
        if [ ! -f $PIDFILE ]; then
            echo "not running"
            exit 1
        fi

        PID=$(cat $PIDFILE)
        kill -HUP $PID 2>/dev/null
        RETVAL=$?

        if [ $RETVAL -eq 0 ]; then
            echo "OK"
        else
            echo "FAILED"
        fi
        ;;

    status)
        if [ ! -f $PIDFILE ]; then
            echo "$NAME is not running"
            exit 3
        fi

        PID=$(cat $PIDFILE)
        if kill -0 $PID 2>/dev/null; then
            echo "$NAME is running (PID $PID)"
            exit 0
        else
            echo "$NAME is not running (stale PID file)"
            exit 1
        fi
        ;;

    *)
        echo "Usage: $0 {start|stop|restart|reload|status}"
        exit 2
        ;;
esac

exit $RETVAL
